# This launches a docker-compose.yaml (defined inline at the bottom)
# NOTE: this file should be converted to ignition.json which can be used with a Flatcar OS
# docker run --rm -i quay.io/coreos/butane:latest < docker-compose-flatcar-config.yaml > ignition.json
variant: flatcar
version: 1.0.0
passwd:
  users:
  - name: core
    ssh_authorized_keys:
      # TODO: insert your public key (the `.pub` file generated by `ssh-keygen`)
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEfhSSquYfwMc66S0ekqySeVWSUbjPL/yv/ZAoniaXQL leej11@local.local
systemd:
  units:
  - name: application.service
    enabled: true
    contents: |
      [Unit]
      Description=Minimalist docker-compose example
      [Service]
      ExecStart=/opt/bin/docker-compose -f /home/core/docker-compose.yaml up
      [Install]
      WantedBy=multi-user.target
storage:
  files:
  - path: /etc/profile.d/opt_bin.sh
    mode: 0755
    contents:
      inline: |
        export PATH=$PATH:/opt/bin
  - path: /opt/bin/docker-compose
    mode: 0755
    contents:
      source: https://github.com/docker/compose/releases/download/v2.24.2/docker-compose-linux-x86_64
      verification:
        hash: sha512-dbb485b512b885de15ff92c24d3ca1b0f46d62bf5dbcd166fd286f545652fa673e4988cfd43a708f7ecfea34ac92538d119c4625e7b3dbb3bb006277f76f9823
  - path: /home/core/.env
    mode: 0644
    user:
      name: core
    group:
      name: core
    contents:
      inline: |
        # private vars go here
  - path: /home/core/docker-compose.yaml
    mode: 0644
    user:
      name: core
    group:
      name: core
    contents:
      # your docker-compose.yaml goes here, modify as necessary
      inline: |
        version: '3.9'
        services:
          kg:
            build:
              context: .
              dockerfile: ./Dockerfile.next
            platform: linux/amd64
            image: maayanlab/final_project:2.2.9
            x-kubernetes:
              imagePullPolicy: IfNotPresent
              annotations:
                maayanlab.cloud/ingress: http://localhost:3000
            ports:
              - 3000:3000
            environment:
              - NEXT_PUBLIC_NEO4J_URL=bolt://neo4j:7687
              - NEXT_PUBLIC_ENRICHR_URL=https://maayanlab.cloud/Enrichr
              - NEXT_PUBLIC_GENESHOT_URL=https://maayanlab.cloud/geneshot
              - NEXT_PUBLIC_NEO4J_USER
              - NEXT_PUBLIC_NEO4J_NAME
              - NEXT_PUBLIC_NEO4J_PASSWORD
              - NEXT_PUBLIC_PREFIX
              - NEXT_PUBLIC_GA_MEASUREMENT_ID
              - NEXT_PUBLIC_HOST
              - NEXT_PUBLIC_SCHEMA
              - NEXT_PUBLIC_TURL
              - NEXT_PUBLIC_TURL_URL
        
          neo4j:
            image: neo4j:4.4
            x-kubernetes:
              imagePullPolicy: IfNotPresent
            environment:
              - NEO4JLABS_PLUGINS='["apoc", "n10s"]'
              - NEO4J_AUTH=${NEXT_PUBLIC_NEO4J_USER}/${NEXT_PUBLIC_NEO4J_PASSWORD}
              - NEO4J_dbms_memory_heap_max__size=4G
              - NEO4J_dbms_memory_heap_initial__size=2G
              - NEO4J_server_config_strict__validation_enabled=false
            ports:
              - 7687:7687
              - 7474:7474
            volumes:
              - final_project-neo4j:/data
        
        volumes:
          final_project-neo4j:
            x-kubernetes:
              size: 25Gi
              class: gp2
        
        x-kubernetes:
          name: final_project
          namespace: final_project
